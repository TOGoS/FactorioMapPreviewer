#!/bin/bash

set -xeuo pipefail


gitref=$(cat .git/$(cat .git/HEAD | sed 's/ref: //'))
vername=$gitref
seed=1
verbose_flag=
verbose=
scales="000.5 001.0 002.0 004.0 008.0 016.0 032.0 100.0"

while [ $# -gt 0 ]
do
    arg="$1"
    shift
    case $arg in
	--seed)
	    seed="$1"
	    shift
	    ;;
	--single-scale)
	    scales=001.0
	    ;;
	--scale)
	    scales="$1"
	    shift
	    ;;
	-v)
	    verbose=1
	    verbose_flag=-v
	    ;;
	-n)
	    vername="$1"
	    shift
	    ;;
	*)
	    echo "$0: Error: Unrecognized argument: $arg" >&2
	    exit 1
    esac
done

for scale in $scales
do
    basefile=map-previews/$vername.seed$seed/$vername.seed$seed.scale$scale
    outfile=$basefile.png
    logfile=$basefile.log
    mkdir -p $(dirname $basefile)
    if [ ! -f $outfile ] || [ ! -f $logfile ]
    then
	bin/debug/factorio $verbose_flag --map-gen-seed=$seed --generate-map-preview=$outfile --map-preview-scale=$scale --map-preview-size=1024 >$logfile 2>&1 && (
	    if [ -n "$verbose" ]
	    then
		cat "$logfile"
	    fi
	) || (
	    echo "Error: Failed to generate $outfile" >&2
	    cat "$logfile" >&2
	    exit 1
	)
    fi
done
